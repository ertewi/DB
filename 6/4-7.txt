# В заданиях 4-7 необходимо выполнить одинаковый запрос, сохраняя его содержимое в различных структурах.
№ Полученную (сохраненную) выборку вывести на экран. В чем отличие этих структур?
# Вывести полную информацию о заказе, его продавце, его продукте и его покупателе, только если:
# количество товара (amt) в этом заказе больше, чем среднее по таблице,
# товар не из Санкт-Петербурга,
# продавец совершил не более 10 заказов за все время,
# рейтинг покупателя не ниже, чем хотя бы у одного покупателя из Москвы.

SELECT * FROM ord o
JOIN prod p ON o.pnum = p.pnum
JOIN cust c ON o.cnum = c.cnum
JOIN sal s ON o.snum = s.snum
WHERE
    o.amt > (SELECT AVG(amt) FROM ord)
    AND p.city != 'Saint Petersburg'
    AND o.snum IN (
        SELECT snum
        FROM ord
        GROUP BY snum
        HAVING COUNT(*) <= 10
    )
    AND c.rating >= (
        SELECT MIN(rating)
        FROM cust
        WHERE city = 'Moscow'
    );


CREATE TABLE order_info AS
SELECT * FROM ord o
JOIN prod p ON o.pnum = p.pnum
JOIN cust c ON o.cnum = c.cnum
JOIN sal s ON o.snum = s.snum
WHERE
    o.amt > (SELECT AVG(amt) FROM ord)
    AND p.city != 'Saint Petersburg'
    AND o.snum IN (
        SELECT snum
        FROM ord
        GROUP BY snum
        HAVING COUNT(*) <= 10
    )
    AND c.rating >= (
        SELECT MIN(rating)
        FROM cust
        WHERE city = 'Moscow'
    );
SELECT * FROM order_info;

CREATE VIEW order_info_view AS
SELECT * FROM ord o
JOIN prod p ON o.pnum = p.pnum
JOIN cust c ON o.cnum = c.cnum
JOIN sal s ON o.snum = s.snum
WHERE
    o.amt > (SELECT AVG(amt) FROM ord)
    AND p.city != 'Saint Petersburg'
    AND o.snum IN (
        SELECT snum
        FROM ord
        GROUP BY snum
        HAVING COUNT(*) <= 10
    )
    AND c.rating >= (
        SELECT MIN(rating)
        FROM cust
        WHERE city = 'Moscow'
    );
SELECT * FROM order_info_view;

CREATE MATERIALIZED VIEW order_info_materialized AS
SELECT * FROM ord o
JOIN prod p ON o.pnum = p.pnum
JOIN cust c ON o.cnum = c.cnum
JOIN sal s ON o.snum = s.snum
WHERE
    o.amt > (SELECT AVG(amt) FROM ord)
    AND p.city != 'Saint Petersburg'
    AND o.snum IN (
        SELECT snum
        FROM ord
        GROUP BY snum
        HAVING COUNT(*) <= 10
    )
    AND c.rating >= (
        SELECT MIN(rating)
        FROM cust
        WHERE city = 'Moscow'
    );
SELECT * FROM order_info_materialized;

WITH sal_orders AS (
    SELECT snum as ord_count
    FROM ord
    GROUP BY snum
    HAVING COUNT(*) <= 10
),
min_rating AS (
    SELECT MIN(rating)
    FROM cust
    WHERE city = 'Moscow'
)
SELECT * FROM ord o
JOIN prod p ON o.pnum = p.pnum
JOIN cust c ON o.cnum = c.cnum
JOIN sal s ON o.snum = s.snum
WHERE
    o.amt > (SELECT AVG(amt) FROM ord)
    AND p.city != 'Saint Petersburg'
    AND o.snum IN (SELECT * FROM sal_orders)
    AND c.rating >= (select * from min_rating);